--// Painel de Controle (UI + Lógica segura)
--// LocalScript (StarterPlayerScripts ou StarterGui)

--=========================
-- Utilidades
--=========================
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

local function formatNumber(n)
	-- 0 deve ser "0" (sem 0.00)
	if not tonumber(n) then return "0" end
	n = tonumber(n)
	if n == 0 then return "0" end
	local suffixes = {"","K","M","B","T","Qa","Qi"}
	local i = 1
	while math.abs(n) >= 1000 and i < #suffixes do
		n = n / 1000
		i += 1
	end
	-- Inteiros sem casas; senão 2 casas
	if math.floor(n) == n then
		return tostring(n)..suffixes[i]
	else
		return string.format("%.2f", n)..suffixes[i]
	end
end

local function getDurability(plr: Player)
	-- Procura Durability em leaderstats ou diretamente no Player
	-- Retorna número (0 se não achar)
	local ok, val = pcall(function()
		local ls = plr:FindFirstChild("leaderstats")
		if ls then
			local d = ls:FindFirstChild("Durability") or ls:FindFirstChild("DURABILITY") or ls:FindFirstChild("Dur")
			if d and d.Value then return tonumber(d.Value) or 0 end
		end
		local d2 = plr:FindFirstChild("Durability") or plr:FindFirstChild("DURABILITY")
		if d2 and d2.Value then return tonumber(d2.Value) or 0 end
		return 0
	end)
	return ok and val or 0
end

local function getStrength(plr: Player)
	-- Usado só para estimar "Can Kill" (placeholder)
	local ls = plr:FindFirstChild("leaderstats")
	if ls then
		local s = ls:FindFirstChild("Strength") or ls:FindFirstChild("STR") or ls:FindFirstChild("Power")
		if s and tonumber(s.Value) then return tonumber(s.Value) end
	end
	return 0
end

--=========================
-- UI (construída via código para rodar em qualquer lugar)
--=========================
local gui = Instance.new("ScreenGui")
gui.Name = "TrollPanel"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Fundo/Topo
local top = Instance.new("Frame")
top.Name = "TopBar"
top.Size = UDim2.fromScale(0.85, 0.22)
top.Position = UDim2.fromScale(0.075, 0.02)
top.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
top.BorderSizePixel = 0
top.Parent = gui

local uiCornerTop = Instance.new("UICorner", top); uiCornerTop.CornerRadius = UDim.new(0, 12)
local shadow = Instance.new("UIStroke", top); shadow.Thickness = 1; shadow.Color = Color3.fromRGB(60,60,60)

-- Botões pretos no topo
local function makeTopButton(text, xScale)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromScale(0.32, 0.28)
	b.Position = UDim2.fromScale(xScale, 0.07)
	b.BackgroundColor3 = Color3.fromRGB(15,15,15)
	b.TextColor3 = Color3.new(1,1,1)
	b.TextScaled = true
	b.Font = Enum.Font.GothamBold
	b.Text = text
	b.AutoButtonColor = true
	b.Parent = top
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
	return b
end

local btnAutoKillPlayer   = makeTopButton("Auto Kill Player", 0.03)
local btnDisableAnimPunch = makeTopButton("Disable Animation Punch", 0.34)
local btnStopAutoKill     = makeTopButton("Stop Auto Kill", 0.65)

-- Botões centrais (verde/vermelho)
local function makeBigButton(text, color, posScale)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromScale(0.35, 0.22)
	b.Position = UDim2.fromScale(posScale, 0.62)
	b.BackgroundColor3 = color
	b.TextColor3 = Color3.new(1,1,1)
	b.TextScaled = true
	b.Font = Enum.Font.GothamBold
	b.Text = text
	b.AutoButtonColor = true
	b.Parent = top
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
	return b
end

local btnKillAll     = makeBigButton("Kill All", Color3.fromRGB(35, 100, 45), 0.12)
local btnStopKillAll = makeBigButton("Stop Kill All", Color3.fromRGB(110, 35, 35), 0.53)

-- Lista (tabela) de jogadores
local listHolder = Instance.new("Frame")
listHolder.Name = "ListHolder"
listHolder.Size = UDim2.fromScale(0.92, 0.62)
listHolder.Position = UDim2.fromScale(0.04, 0.27)
listHolder.BackgroundTransparency = 1
listHolder.Parent = gui

local list = Instance.new("ScrollingFrame")
list.Size = UDim2.fromScale(1,1)
list.CanvasSize = UDim2.new()
list.ScrollBarThickness = 6
list.BackgroundTransparency = 1
list.Parent = listHolder

local layout = Instance.new("UIListLayout", list)
layout.FillDirection = Enum.FillDirection.Vertical
layout.Padding = UDim.new(0, 4)

-- Template de linha
local function createRow()
	local row = Instance.new("Frame")
	row.Name = "Row"
	row.Size = UDim2.new(1, 0, 0, 42)
	row.BackgroundColor3 = Color3.fromRGB(90, 30, 225) -- roxo/azulado como na imagem
	row.BorderSizePixel = 0
	Instance.new("UICorner", row).CornerRadius = UDim.new(0,6)

	-- Nome
	local nameLbl = Instance.new("TextLabel")
	nameLbl.Name = "PlayerName"
	nameLbl.Size = UDim2.fromScale(0.24, 1)
	nameLbl.Position = UDim2.fromScale(0.02, 0)
	nameLbl.BackgroundTransparency = 1
	nameLbl.Font = Enum.Font.GothamBold
	nameLbl.TextScaled = true
	nameLbl.TextXAlignment = Enum.TextXAlignment.Left
	nameLbl.TextColor3 = Color3.new(1,1,1)
	nameLbl.Parent = row

	-- Durability
	local duraLbl = Instance.new("TextLabel")
	duraLbl.Name = "Durability"
	duraLbl.Size = UDim2.fromScale(0.36, 1)
	duraLbl.Position = UDim2.fromScale(0.26, 0)
	duraLbl.BackgroundTransparency = 1
	duraLbl.Font = Enum.Font.GothamBold
	duraLbl.TextScaled = true
	duraLbl.TextXAlignment = Enum.TextXAlignment.Left
	duraLbl.TextColor3 = Color3.new(0.8, 0.95, 1)
	duraLbl.Parent = row

	-- "Can Kill" (status)
	local canKill = Instance.new("TextLabel")
	canKill.Name = "CanKill"
	canKill.Size = UDim2.fromScale(0.14, 1)
	canKill.Position = UDim2.fromScale(0.62, 0)
	canKill.BackgroundColor3 = Color3.fromRGB(200, 40, 40)
	canKill.TextColor3 = Color3.new(1,1,1)
	canKill.TextScaled = true
	canKill.Font = Enum.Font.GothamBold
	canKill.Text = "Can Kill"
	Instance.new("UICorner", canKill).CornerRadius = UDim.new(0,6)
	canKill.Parent = row

	-- Teleport (simulado: “spectate” por 5s)
	local tp = Instance.new("TextButton")
	tp.Name = "Teleport"
	tp.Size = UDim2.fromScale(0.12, 1)
	tp.Position = UDim2.fromScale(0.76, 0)
	tp.BackgroundColor3 = Color3.fromRGB(40, 200, 230)
	tp.TextColor3 = Color3.new(1,1,1)
	tp.TextScaled = true
	tp.Font = Enum.Font.GothamBold
	tp.Text = "Teleport"
	Instance.new("UICorner", tp).CornerRadius = UDim.new(0,6)
	tp.Parent = row

	-- Past (apenas botão visual)
	local past = Instance.new("TextButton")
	past.Name = "Past"
	past.Size = UDim2.fromScale(0.12, 1)
	past.Position = UDim2.fromScale(0.89, 0)
	past.BackgroundColor3 = Color3.fromRGB(230, 120, 50)
	past.TextColor3 = Color3.new(1,1,1)
	past.TextScaled = true
	past.Font = Enum.Font.GothamBold
	past.Text = "Past"
	Instance.new("UICorner", past).CornerRadius = UDim.new(0,6)
	past.Parent = row

	return row
end

--=========================
-- Lógica de lista e botões
--=========================
local rowsByUserId: {[number]: Frame} = {}

local function updateRow(plr: Player)
	if not plr or not plr.Parent then return end
	local row = rowsByUserId[plr.UserId]
	if not row then
		row = createRow()
		row.Parent = list
		rowsByUserId[plr.UserId] = row

		-- Ações dos botões por linha
		row.Teleport.MouseButton1Click:Connect(function()
			-- Seguro: espectar o jogador 5s (sem teleporte real)
			local cam = workspace.CurrentCamera
			local myChar = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
			local myHum = myChar:FindFirstChildWhichIsA("Humanoid")
			local targetChar = plr.Character
			local targetHum = targetChar and targetChar:FindFirstChildWhichIsA("Humanoid")
			if targetHum then
				local oldSubject = cam.CameraSubject
				cam.CameraSubject = targetHum
				StarterGui:SetCore("SendNotification", {Title="Teleport (simulado)", Text="Espectando "..plr.Name.." por 5s"; Duration=2})
				task.delay(5, function()
					if myHum then cam.CameraSubject = myHum end
				end)
			end
			-- TODO: Teleporte real (se for o seu jogo): mova o HumanoidRootPart do LocalPlayer até o do alvo usando RemoteEvent do servidor
		end)

		row.Past.MouseButton1Click:Connect(function()
			print("[Past] Clique em "..plr.Name)
			-- TODO: Defina o que "Past" deve fazer no seu jogo
		end)
	end

	-- Preencher dados
	local d = getDurability(plr)
	row.PlayerName.Text = plr.Name
	row.Durability.Text = "Durability: "..formatNumber(d)

	-- Placeholder: estimativa "Can Kill"
	local myStr = getStrength(LocalPlayer)
	if myStr > 0 and d > 0 and myStr >= d then
		row.CanKill.Text = "Can Kill"
		row.CanKill.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
	else
		row.CanKill.Text = "Hard"
		row.CanKill.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
	end
end

local function addPlayer(plr: Player)
	updateRow(plr)
	-- Observa mudanças de stats para atualizar em tempo real
	local function watchStats(container)
		if not container then return end
		container.ChildAdded:Connect(function()
			updateRow(plr)
		end)
		container.ChildRemoved:Connect(function()
			updateRow(plr)
		end)
		for _, v in ipairs(container:GetChildren()) do
			if v:IsA("NumberValue") then
				v:GetPropertyChangedSignal("Value"):Connect(function()
					updateRow(plr)
				end)
			end
		end
	end
	task.defer(function()
		watchStats(plr:FindFirstChild("leaderstats"))
		watchStats(plr)
	end)
end

local function removePlayer(plr: Player)
	local row = rowsByUserId[plr.UserId]
	if row then
		row:Destroy()
		rowsByUserId[plr.UserId] = nil
	end
end

-- Popular lista inicial
for _, plr in ipairs(Players:GetPlayers()) do
	addPlayer(plr)
end
Players.PlayerAdded:Connect(addPlayer)
Players.PlayerRemoving:Connect(removePlayer)

-- Atualização periódica (refina CanKill e Durability)
RunService.Heartbeat:Connect(function(step)
	for _, plr in ipairs(Players:GetPlayers()) do
		updateRow(plr)
	end
	-- Ajusta altura do canvas
	local total = 0
	for _, child in ipairs(list:GetChildren()) do
		if child:IsA("Frame") then total += child.AbsoluteSize.Y + layout.Padding.Offset end
	end
	list.CanvasSize = UDim2.new(0,0,0, math.max(0, total))
end)

--=========================
-- Botões superiores (placeholders seguros)
--=========================
local autoKillOn = false
btnAutoKillPlayer.MouseButton1Click:Connect(function()
	autoKillOn = true
	print("[Auto Kill] ON (placeholder)")
	StarterGui:SetCore("SendNotification", {Title="Auto Kill", Text="Ligado (simulado)"; Duration=2})
	-- TODO: sua rotina de auto-kill (no seu jogo, via RemoteEvents)
end)

btnStopAutoKill.MouseButton1Click:Connect(function()
	autoKillOn = false
	print("[Auto Kill] OFF")
	StarterGui:SetCore("SendNotification", {Title="Auto Kill", Text="Desligado"; Duration=2})
end)

local disablePunch = false
btnDisableAnimPunch.MouseButton1Click:Connect(function()
	disablePunch = not disablePunch
	print("[Disable Animation Punch]:", disablePunch)
	StarterGui:SetCore("SendNotification", {
		Title="Disable Animation Punch",
		Text = disablePunch and "Ativado" or "Desativado",
		Duration=2
	})
	-- TODO: aqui você pode desabilitar/anular animações locais do seu jogo
end)

btnKillAll.MouseButton1Click:Connect(function()
	print("[Kill All] (placeholder)")
	StarterGui:SetCore("SendNotification", {Title="Kill All", Text="Comando simulado"; Duration=2})
	-- TODO: servidor aplicar dano/remoção em todos (se for seu jogo)
end)

btnStopKillAll.MouseButton1Click:Connect(function()
	print("[Stop Kill All] (placeholder)")
	StarterGui:SetCore("SendNotification", {Title="Stop Kill All", Text="Comando simulado"; Duration=2})
end)
