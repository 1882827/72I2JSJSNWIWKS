local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

local function formatNumber(n)
	if not tonumber(n) then return "0" end
	n = tonumber(n)
	if n == 0 then return "0" end
	local suffixes = {"","K","M","B","T","Qa","Qi"}
	local i = 1
	while math.abs(n) >= 1000 and i < #suffixes do
		n = n / 1000
		i += 1
	end
	if math.floor(n) == n then
		return tostring(n)..suffixes[i]
	else
		return string.format("%.2f", n)..suffixes[i]
	end
end

local function getDurability(plr: Player)
	local ok, val = pcall(function()
		local ls = plr:FindFirstChild("leaderstats")
		if ls then
			local d = ls:FindFirstChild("Durability") or ls:FindFirstChild("DURABILITY") or ls:FindFirstChild("Dur")
			if d and d.Value then return tonumber(d.Value) or 0 end
		end
		local d2 = plr:FindFirstChild("Durability") or plr:FindFirstChild("DURABILITY")
		if d2 and d2.Value then return tonumber(d2.Value) or 0 end
		return 0
	end)
	return ok and val or 0
end

local function getStrength(plr: Player)
	local ls = plr:FindFirstChild("leaderstats")
	if ls then
		local s = ls:FindFirstChild("Strength") or ls:FindFirstChild("STR") or ls:FindFirstChild("Power")
		if s and tonumber(s.Value) then return tonumber(s.Value) end
	end
	return 0
end

local gui = Instance.new("ScreenGui")
gui.Name = "TrollPanel"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.fromScale(0.6, 0.7)
mainFrame.Position = UDim2.fromScale(0.2, 0.15)
mainFrame.BackgroundColor3 = Color3.fromRGB(40,40,40)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = gui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0,8)

local titleBar = Instance.new("Frame")
titleBar.Name = "TitleBar"
titleBar.Size = UDim2.new(1,0,0,35)
titleBar.BackgroundColor3 = Color3.fromRGB(30,30,30)
titleBar.Parent = mainFrame
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0,8)

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(0.8,0,1,0)
titleLabel.Position = UDim2.new(0.02,0,0,0)
titleLabel.BackgroundTransparency = 1
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextScaled = true
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.TextColor3 = Color3.new(1,1,1)
titleLabel.Text = "Sad v1.0.02 | See Stats"
titleLabel.Parent = titleBar

local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0,35,1,0)
minimizeBtn.Position = UDim2.new(0.88,0,0,0)
minimizeBtn.BackgroundColor3 = Color3.fromRGB(20,20,20)
minimizeBtn.Text = "-"
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextColor3 = Color3.new(1,1,1)
minimizeBtn.TextScaled = true
minimizeBtn.Parent = titleBar
Instance.new("UICorner", minimizeBtn).CornerRadius = UDim.new(0,6)

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0,35,1,0)
closeBtn.Position = UDim2.new(0.95,0,0,0)
closeBtn.BackgroundColor3 = Color3.fromRGB(20,20,20)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextColor3 = Color3.new(1,1,1)
closeBtn.TextScaled = true
closeBtn.Parent = titleBar
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0,6)

local minimized = false
minimizeBtn.MouseButton1Click:Connect(function()
	minimized = not minimized
	for _, child in ipairs(mainFrame:GetChildren()) do
		if child ~= titleBar then
			child.Visible = not minimized
		end
	end
end)

closeBtn.MouseButton1Click:Connect(function()
	mainFrame.Visible = false
end)

local top = Instance.new("Frame")
top.Name = "TopBar"
top.Size = UDim2.fromScale(0.85, 0.25)
top.Position = UDim2.fromScale(0.075, 0.1)
top.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
top.BorderSizePixel = 0
top.Parent = mainFrame
Instance.new("UICorner", top).CornerRadius = UDim.new(0, 6)

local function makeTopButton(text, xScale)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromScale(0.31, 0.28)
	b.Position = UDim2.fromScale(xScale, 0.08)
	b.BackgroundColor3 = Color3.fromRGB(0,0,0)
	b.TextColor3 = Color3.new(1,1,1)
	b.TextScaled = true
	b.TextWrapped = true
	b.Font = Enum.Font.GothamBold
	b.Text = text
	b.AutoButtonColor = true
	b.Parent = top
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,4)
	return b
end

local btnAutoKillPlayer   = makeTopButton("Matar Automaticamente o Jogador", 0.03)
local btnDisableAnimPunch = makeTopButton("Disable Animation Punch", 0.34)
local btnStopAutoKill     = makeTopButton("Stop Auto Kill", 0.65)

local function makeBigButton(text, color, posScale)
	local b = Instance.new("TextButton")
	b.Size = UDim2.fromScale(0.4, 0.26)
	b.Position = UDim2.fromScale(posScale, 0.62)
	b.BackgroundColor3 = color
	b.TextColor3 = Color3.new(1,1,1)
	b.TextScaled = true
	b.TextWrapped = true
	b.Font = Enum.Font.GothamBold
	b.Text = text
	b.AutoButtonColor = true
	b.Parent = top
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,6)
	return b
end

local btnKillAll     = makeBigButton("Kill All", Color3.fromRGB(35, 100, 45), 0.12)
local btnStopKillAll = makeBigButton("Stop Kill All", Color3.fromRGB(110, 35, 35), 0.53)

local listHolder = Instance.new("Frame")
listHolder.Name = "ListHolder"
listHolder.Size = UDim2.fromScale(0.92, 0.62)
listHolder.Position = UDim2.fromScale(0.04, 0.37)
listHolder.BackgroundTransparency = 1
listHolder.Parent = mainFrame

local list = Instance.new("ScrollingFrame")
list.Size = UDim2.fromScale(1,1)
list.CanvasSize = UDim2.new()
list.ScrollBarThickness = 6
list.BackgroundTransparency = 1
list.Parent = listHolder

local layout = Instance.new("UIListLayout", list)
layout.FillDirection = Enum.FillDirection.Vertical
layout.Padding = UDim.new(0, 4)

local function createRow()
	local row = Instance.new("Frame")
	row.Name = "Row"
	row.Size = UDim2.new(1, 0, 0, 42)
	row.BackgroundColor3 = Color3.fromRGB(90, 0, 200)
	row.BorderSizePixel = 0
	Instance.new("UICorner", row).CornerRadius = UDim.new(0,4)

	local nameLbl = Instance.new("TextLabel")
	nameLbl.Name = "PlayerName"
	nameLbl.Size = UDim2.fromScale(0.23, 1)
	nameLbl.Position = UDim2.fromScale(0.02, 0)
	nameLbl.BackgroundTransparency = 1
	nameLbl.Font = Enum.Font.GothamBold
	nameLbl.TextScaled = true
	nameLbl.TextWrapped = true
	nameLbl.TextXAlignment = Enum.TextXAlignment.Left
	nameLbl.TextColor3 = Color3.new(1,1,1)
	nameLbl.Parent = row

	local duraLbl = Instance.new("TextLabel")
	duraLbl.Name = "Durability"
	duraLbl.Size = UDim2.fromScale(0.33, 1)
	duraLbl.Position = UDim2.fromScale(0.26, 0)
	duraLbl.BackgroundTransparency = 1
	duraLbl.Font = Enum.Font.GothamBold
	duraLbl.TextScaled = true
	duraLbl.TextWrapped = true
	duraLbl.TextXAlignment = Enum.TextXAlignment.Left
	duraLbl.TextColor3 = Color3.fromRGB(200, 240, 255)
	duraLbl.Parent = row

	local canKill = Instance.new("TextLabel")
	canKill.Name = "CanKill"
	canKill.Size = UDim2.fromScale(0.14, 1)
	canKill.Position = UDim2.fromScale(0.62, 0)
	canKill.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
	canKill.TextColor3 = Color3.new(1,1,1)
	canKill.TextScaled = true
	canKill.TextWrapped = true
	canKill.Font = Enum.Font.GothamBold
	canKill.Text = "Can Kill"
	Instance.new("UICorner", canKill).CornerRadius = UDim.new(0,4)
	canKill.Parent = row

	local tp = Instance.new("TextButton")
	tp.Name = "Teleport"
	tp.Size = UDim2.fromScale(0.12, 1)
	tp.Position = UDim2.fromScale(0.76, 0)
	tp.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
	tp.TextColor3 = Color3.new(1,1,1)
	tp.TextScaled = true
	tp.TextWrapped = true
	tp.Font = Enum.Font.GothamBold
	tp.Text = "Teletransportar"
	Instance.new("UICorner", tp).CornerRadius = UDim.new(0,4)
	tp.Parent = row

	local past = Instance.new("TextButton")
	past.Name = "Past"
	past.Size = UDim2.fromScale(0.12, 1)
	past.Position = UDim2.fromScale(0.89, 0)
	past.BackgroundColor3 = Color3.fromRGB(255, 120, 40)
	past.TextColor3 = Color3.new(1,1,1)
	past.TextScaled = true
	past.TextWrapped = true
	past.Font = Enum.Font.GothamBold
	past.Text = "Past"
	Instance.new("UICorner", past).CornerRadius = UDim.new(0,4)
	past.Parent = row

	return row
end

local rowsByUserId: {[number]: Frame} = {}

local function updateRow(plr: Player)
	if not plr or not plr.Parent then return end
	local row = rowsByUserId[plr.UserId]
	if not row then
		row = createRow()
		row.Parent = list
		rowsByUserId[plr.UserId] = row

		row.Teleport.MouseButton1Click:Connect(function()
			local cam = workspace.CurrentCamera
			local myChar = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
			local myHum = myChar:FindFirstChildWhichIsA("Humanoid")
			local targetChar = plr.Character
			local targetHum = targetChar and targetChar:FindFirstChildWhichIsA("Humanoid")
			if targetHum then
				local oldSubject = cam.CameraSubject
				cam.CameraSubject = targetHum
				StarterGui:SetCore("SendNotification", {Title="Teleport (simulado)", Text="Espectando "..plr.Name.." por 5s"; Duration=2})
				task.delay(5, function()
					if myHum then cam.CameraSubject = myHum end
				end)
			end
		end)

		row.Past.MouseButton1Click:Connect(function()
			print("[Past] Clique em "..plr.Name)
		end)
	end

	local d = getDurability(plr)
	row.PlayerName.Text = plr.Name
	row.Durability.Text = "Durability: "..formatNumber(d)

	local myStr = getStrength(LocalPlayer)
	if myStr > 0 and d > 0 and myStr >= d then
		row.CanKill.Text = "Can Kill"
		row.CanKill.BackgroundColor3 = Color3.fromRGB(220, 60, 60)
	else
		row.CanKill.Text = "Hard"
		row.CanKill.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
	end
end

local function addPlayer(plr: Player)
	updateRow(plr)
	local function watchStats(container)
		if not container then return end
		container.ChildAdded:Connect(function()
			updateRow(plr)
		end)
		container.ChildRemoved:Connect(function()
			updateRow(plr)
		end)
		for _, v in ipairs(container:GetChildren()) do
			if v:IsA("NumberValue") then
				v:GetPropertyChangedSignal("Value"):Connect(function()
					updateRow(plr)
				end)
			end
		end
	end
	task.defer(function()
		watchStats(plr:FindFirstChild("leaderstats"))
		watchStats(plr)
	end)
end

local function removePlayer(plr: Player)
	local row = rowsByUserId[plr.UserId]
	if row then
		row:Destroy()
		rowsByUserId[plr.UserId] = nil
	end
end

for _, plr in ipairs(Players:GetPlayers()) do
	addPlayer(plr)
end
Players.PlayerAdded:Connect(addPlayer)
Players.PlayerRemoving:Connect(removePlayer)

RunService.Heartbeat:Connect(function(step)
	for _, plr in ipairs(Players:GetPlayers()) do
		updateRow(plr)
	end
	local total = 0
	for _, child in ipairs(list:GetChildren()) do
		if child:IsA("Frame") then total += child.AbsoluteSize.Y + layout.Padding.Offset end
	end
	list.CanvasSize = UDim2.new(0,0,0, math.max(0, total))
end)

local autoKillOn = false
btnAutoKillPlayer.MouseButton1Click:Connect(function()
	autoKillOn = true
	StarterGui:SetCore("SendNotification", {Title="Auto Kill", Text="Ligado (simulado)"; Duration=2})
end)

btnStopAutoKill.MouseButton1Click:Connect(function()
	autoKillOn = false
	StarterGui:SetCore("SendNotification", {Title="Auto Kill", Text="Desligado"; Duration=2})
end)

local disablePunch = false
btnDisableAnimPunch.MouseButton1Click:Connect(function()
	disablePunch = not disablePunch
	StarterGui:SetCore("SendNotification", {
		Title="Disable Animation Punch",
		Text = disablePunch and "Ativado" or "Desativado",
		Duration=2
	})
end)

btnKillAll.MouseButton1Click:Connect(function()
	StarterGui:SetCore("SendNotification", {Title="Kill All", Text="Comando simulado"; Duration=2})
end)

btnStopKillAll.MouseButton1Click:Connect(function()
	StarterGui:SetCore("SendNotification", {Title="Stop Kill All", Text="Comando simulado"; Duration=2})
end)
